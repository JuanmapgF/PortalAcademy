package Controlador;

import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import javax.swing.JOptionPane;

import Modelo.BD;
import Modelo.ErrorBD;
import Vista.Registro;

public class ControladorRegistro implements ActionListener {

	private Registro vista;

	private BD bd;

	public ControladorRegistro(Registro v) {
		vista = v;
		vista.rdbtnEstudiante.addActionListener(this);
		vista.rdbtnOrganizacion.addActionListener(this);
		vista.rdbtnProfesor.addActionListener(this);
		vista.btnRegistro.addActionListener(this);
	}

	public Registro getPanel() {
		return vista;
	}

	@Override
	public void actionPerformed(ActionEvent e) {

		if (e.getSource() == vista.rdbtnEstudiante) {
			vista.lblInfoAdicional.setText("");
			vista.lblInfoAdicional.setVisible(false);
			vista.textFieldInfoAdicional.setText("");
			vista.textFieldInfoAdicional.setVisible(false);
			vista.textFieldCodigo.setVisible(false);
			vista.textFieldCodigo.setText("");
		}

		if (e.getSource() == vista.rdbtnOrganizacion) {
			vista.lblInfoAdicional.setText("Sede:");
			vista.lblInfoAdicional.setVisible(true);
			vista.textFieldInfoAdicional.setText("");
			vista.textFieldInfoAdicional.setVisible(true);
			vista.textFieldCodigo.setVisible(false);
			vista.textFieldCodigo.setText("");
		}

		if (e.getSource() == vista.rdbtnProfesor) {
			vista.lblInfoAdicional.setText("Teléfono:");
			vista.lblInfoAdicional.setVisible(true);
			vista.textFieldInfoAdicional.setText("");
			vista.textFieldInfoAdicional.setVisible(true);
			vista.textFieldCodigo.setText("");
			vista.textFieldCodigo.setVisible(true);
		}

		if (e.getSource() == vista.btnRegistro) {
			try {

				if (!nickValido()) {
					throw new ErrorBD(
							"El nick debe tener al menos 4 caracteres, y debe estar formado solamente por letras y digitos.");
				}

				if (!nickDisponible()) {
					throw new ErrorBD("El nick que has introducido ya ha sido utilizado.");
				}

				if (!correoValido()) {
					throw new ErrorBD("El correo introducido debe ser válido.");
				}

				if (!correoDisponible()) {
					throw new ErrorBD("El correo que has introducido ya ha sido utilizado.");
				}

				if (!contrasenaValida()) {
					throw new ErrorBD(
							"La contraseña tiene que tener al menos 6 caracteres, una mayúscula, una minúscula y un dígito.");
				}

				if (vista.rdbtnProfesor.isSelected() && !telefonoValido()) {
					throw new ErrorBD("El telefono no es valido. Introduzca el codigo de su pais y el telefono.");
				}

				if (vista.rdbtnEstudiante.isSelected()) {
					
				} else if (vista.rdbtnProfesor.isSelected()) {
					
				} else if (vista.rdbtnOrganizacion.isSelected()) {
					
				}

			} catch (ErrorBD err) {
				JOptionPane.showMessageDialog(vista, err.getMessage(), "Error al registrarse",
						JOptionPane.ERROR_MESSAGE);
			}
		}

	}

	private boolean telefonoValido() {
		Pattern pattern1 = Pattern.compile("^(?=\\w*\\d)\\S{1,4}$");
		Matcher mather1 = pattern1.matcher(vista.textFieldCodigo.getText());
		Pattern pattern2 = Pattern.compile("^(?=\\w*\\d)\\S{3,15}$");
		Matcher mather2 = pattern2.matcher(vista.textFieldInfoAdicional.getText());
		return mather1.find() && mather2.find();
	}

	private boolean correoDisponible() {
		bd = BD.getBD();
		int ccorreo = Integer.parseInt(bd.SelectEscalar(
				"SELECT COUNT(correo) FROM Usuario WHERE Usuario.correo = '" + vista.textFieldCorreo.getText() + "'")
				.toString());
		bd.finalize();
		return ccorreo == 0;
	}

	public boolean correoValido() {
		Pattern pattern = Pattern.compile(
				"^[_A-Za-z0-9-\\+]+(\\.[_A-Za-z0-9-]+)*@" + "[A-Za-z0-9-]+(\\.[A-Za-z0-9]+)*(\\.[A-Za-z]{2,4})$");
		Matcher mather = pattern.matcher(vista.textFieldCorreo.getText());
		return mather.find();
	}

	private boolean nickValido() {
		Pattern pattern = Pattern.compile("^[A-Za-z0-9]\\S{3,30}");
		Matcher mather = pattern.matcher(vista.textFieldNick.getText());
		return mather.find();
	}

	private boolean nickDisponible() {
		bd = BD.getBD();
		int cnick = Integer.parseInt(bd.SelectEscalar("SELECT COUNT(nick) FROM Usuario WHERE Usuario.nick = '"
				+ vista.textFieldNick.getText().toUpperCase() + "'").toString());
		bd.finalize();
		return cnick == 0;
	}

	private boolean contrasenaValida() {
		Pattern pattern = Pattern.compile("^(?=\\w*\\d)(?=\\w*[A-Z])(?=\\w*[a-z])\\S{6,20}$");
		Matcher mather = pattern.matcher(new String(vista.passwordFieldContrasena.getPassword()));
		return mather.find();
	}

}
